@model RegistroJATICS.Models.RegisterViewModel
@{
    ViewBag.Title = "Registro";
    string defDescripcion = ViewBag.defDescripcion;
    int CantidadParticipantes = ViewBag.CantidadParticipantes;
    int cantRegistrados = ViewBag.cantRegistrados;
}

<h2>@ViewBag.Title.</h2>
<h4>Crear una Nueva Cuenta.</h4>
<hr />
<div class="alert alert-danger" role="alert">El <strong>Nombre de Usuario</strong> será el usuario utilizado para tu sesión<br />El <strong>Nombre Completo</strong> será el que aparecerá en tu certificado</div>
<div class="alert alert-info">Introduce un <strong>password</strong> fácil de recordar, solamente se pide para indetificarte dentro del sistema de registro.</div>
<div class="row">
    @using (Html.BeginForm("Register", "Account", FormMethod.Post, new { @class = "form-horizontal col-md-8", role = "form" }))
    {
        @Html.AntiForgeryToken()
        
        @Html.ValidationSummary("", new { @class = "text-danger" })
        <div class="form-group">
            @Html.LabelFor(m => m.UserName, new { @class = "col-md-2 control-label" })
            <div class="col-md-10">
                @Html.TextBoxFor(m => m.UserName, new { @class = "form-control" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.NombreAsistente, new { @class = "col-md-2 control-label" })
            <div class="col-md-10">
                @Html.TextBoxFor(m => m.NombreAsistente, new { @class = "form-control" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Email, new { @class = "col-md-2 control-label" })
            <div class="col-md-10">
                @Html.TextBoxFor(m => m.Email, new { @class = "form-control" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model, "Taller", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownListFor(model => model.ID_Taller, (SelectList)ViewBag.Taller, htmlAttributes: new { @class = "form-control" })
                @Html.ValidationMessageFor(model => model.ID_Taller, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Nombre_Institucion, "Institucion", htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.DropDownListFor(model => model.Nombre_Institucion, (SelectList)ViewBag.Institucion, htmlAttributes: new { @class = "form-control" })
                @Html.ValidationMessageFor(model => model.Nombre_Institucion, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Password, new { @class = "col-md-2 control-label" })
            <div class="col-md-10">
                @Html.PasswordFor(m => m.Password, new { @class = "form-control" })
                <span class="alert-info">Mínimo 4 caracteres.</span>
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.ConfirmPassword, new { @class = "col-md-2 control-label" })
            <div class="col-md-10">
                @Html.PasswordFor(m => m.ConfirmPassword, new { @class = "form-control" })
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Confirmar registro</h4>
                    </div>
                    <div class="modal-body">
                        <p>Tu nombre completo quedará registrado en las listas de asistencia y
                        constancias de la siguiente manera:</p>
                        <strong id="confirmaNombreCompleto"></strong>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="btn btn-primary" value="Confirmar" />
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>
                </div>

            </div>
        </div>
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <button id="btnRegistrar"
                        type="button" class="btn btn-default" 
                        data-toggle="modal" 
                        data-target="#myModal"
                        @(cantRegistrados>=CantidadParticipantes?"disabled":"")
                        >Registrar</button>
                <span id="msgCupoMaximo" style="display:none" class="alert-danger">Cupo agotado</span>
            </div>
        </div>
    }
    <div class="col-md-4">
        <div class="panel panel-info">
            <div class="panel-heading">Descripción de taller</div>
            <div class="panel-body">
                <div id="descripcionTaller">
                    <p>
                        @(String.IsNullOrEmpty(defDescripcion) ? "No hay descripción disponible" : defDescripcion)
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $("#ID_Taller").change(function () {
            tallerID = $(this).val();
            $.ajax({
                url: '/Tallers/getDescripcion',
                type: 'get',
                data: { id: tallerID },
                dataType: 'JSON',
                success: function (result, status, xhr) {
                    descripcion = result.descripcion == null ? "No hay descripción disponible"
                        : result.descripcion;

                    CantidadParticipantes = result.CantidadParticipantes;
                    cantRegistrados = result.cantRegistrados;

                    $("#btnRegistrar").prop("disabled", cantRegistrados >= CantidadParticipantes)
                    if (cantRegistrados >= CantidadParticipantes){
                        $("#msgCupoMaximo").fadeIn();
                    } else {
                        $("#msgCupoMaximo").fadeOut();
                    }


                    $("#descripcionTaller").slideUp(500).slideDown(500);
                    $("#descripcionTaller>p").fadeOut(500).fadeIn(500);
                    setTimeout(function () { $("#descripcionTaller>p").html(descripcion) }, 500);
                },
                error: function (xhr, status, error) {
                    alert(error);
                }
            });
        });
        $("input#NombreAsistente").keyup(function () {
            $("#confirmaNombreCompleto").html($(this).val());
        })
    </script>
}
